### M1.7.3 · Biometric-Trigger Logic

**Epic:** 1.7 Health Signals\
**Status:** 🟡 Planned

---

## Goal

Detect meaningful drops in daily step count and sleep duration, flag
disengagement, and trigger AI Coach prompts plus Momentum Score adjustments.

## Success Criteria

- `biometric_flag_detector` edge function runs in <500 ms; schedule every 2 min.
- Flag detection latency <2 min from data ingest to `biometric_flags` row.
- ≥95 % of simulated drop events create a flag (integration test).
- Coach prompt delivered within 30 s of flag insertion (staging).
- `flutter analyze --fatal-warnings` passes; overall coverage ≥90 % for function
  & RLS.

## Milestone Breakdown

| Task ID | Description                                                              | Est. Hrs | Status |
| ------- | ------------------------------------------------------------------------ | -------- | ------ |
| T1      | Create `biometric_flags` table + RLS                                     | 3h       | 🟡     |
| T2      | Edge function `biometric_flag_detector@1.0.0` (steps & sleep drop rules) | 6h       | 🟡     |
| T3      | AI Coach prompt integration with template variants                       | 4h       | 🟡     |
| T4      | Momentum Score update when user confirms disengagement                   | 3h       | 🟡     |
| T5      | Integration tests with Supabase emulator & mocked Coach API              | 3h       | 🟡     |

## Milestone Deliverables

- SQL migration `supabase/migrations/<timestamp>_create_biometric_flags.sql`.
- RLS policies enforcing owner access on `biometric_flags`.
- Edge function code under `supabase/functions/biometric-flag-detector/` tagged
  `v1.0.0`.
- Prompt templates in `app/lib/core/prompts/biometric_drop.dart` (or shared TS
  helper for edge).
- Service layer update `core/health_data/biometric_flag_service.dart`.
- Integration test suite
  `supabase/functions/tests/biometric_flag_detector.test.ts`.
- Updated Momentum Score modifier hook.
- This spec document.

## Implementation Details

### 1. Database

```sql
-- biometric_flags table
CREATE TABLE biometric_flags (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES auth.users NOT NULL,
  flag_type text CHECK (flag_type IN ('low_steps', 'low_sleep')),
  detected_on timestamptz NOT NULL DEFAULT now(),
  details jsonb,
  resolved boolean NOT NULL DEFAULT false
);

-- indexes
CREATE INDEX idx_biometric_flags_user_time ON biometric_flags (user_id, detected_on DESC);

-- RLS (owner only)
ALTER TABLE biometric_flags ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Owner can read/write own flags" ON biometric_flags
  USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id);
```

### 2. Edge Function `biometric_flag_detector@1.0.0`

- Location: `supabase/functions/biometric-flag-detector/index.ts`
- Environment: Deno, TypeScript, SemVer tag `v1.0.0`.
- Trigger: Supabase scheduled cron every 2 min.
- Logic:
  1. Query step & sleep aggregates for previous 7 days per user
     (`health_aggregates_daily`).
  2. If yesterday’s steps <60 % of 7-day mean OR sleep <75 % → create flag.
  3. Skip if unresolved flag of same type exists <24 h.
  4. Broadcast `realtime.broadcast("biometric_flag", payload)` for app
     listeners.
- Unit tests cover threshold maths and idempotency.

### 3. AI Coach Prompt Integration

- On flag insert, call `coach-interactions-api` edge function:

```json
{
    "user_id": "<uuid>",
    "template": "biometric_drop",
    "flag_type": "low_steps"
}
```

- Prompt templates live in `_shared/coachPromptTemplates.ts` with variants for
  `low_steps` & `low_sleep`.

### 4. Momentum Score Update

- When user responds “Yes, I’ve slacked” (chat intent), client hits
  `update_momentum_from_biometrics` function with `{ penalty: -10 }`.
- Existing listener in Epic 1.8 consumes the event to adjust score.

### 5. Testing Strategy

| Layer        | Approach                                                        |
| ------------ | --------------------------------------------------------------- |
| SQL          | pgTAP assertions for table & RLS                                |
| Function     | Deno test mocks: synthetic aggregates, expect flag insert       |
| Integration  | Supabase emulator + mocked Coach API; verify prompt & flag rows |
| Dart Service | Unit test provider returns parsed flags                         |

All tests must reach ≥90 % line & branch coverage.

### 6. Coding Rules Applied

- Supabase functions tagged with SemVer; Deno style adheres to `deno.json`.
- Do not use 'Any' when coding Typescript
- Flutter side imports `responsive_services.dart` & `theme.dart` — no magic
  numbers.
- Respect `analysis_options.yaml`; null-safety enforced.
- No file >300 LOC; split into data-layer, service-layer, UI.

## Acceptance Criteria

- Migration applies cleanly with `supabase db reset`.
- Edge function deploy succeeds; returns 200 & empty body when no flags.
- Integration tests pass in CI <10 min; coverage & lint gates green.
- Coach prompt appears in staging within SLA; chat flow updates Momentum Score.

## Dependencies / Notes

- Supabase secrets: `~/.bee_secrets/supabase.env`.
- Requires step/sleep aggregates from Health Data Ingestion pipeline.
- Depends on AI Coach Conversation Engine endpoint `/coach_prompt`.
- Momentum Score modifier listener (Epic 1.8) must accept penalty events.
