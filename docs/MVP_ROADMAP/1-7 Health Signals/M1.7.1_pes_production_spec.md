### M1.7.1 Â· Perceived Energy Score (PES) â€“ Production Roll-Out

**Epic:** 1.7 Health Signals  \  **Status:** ðŸŸ¡ Planned

---

## ðŸŽ¯ Goal

Ship a complete, user-facing Perceived Energy Score (PES) feature: users can record a daily 1â€“5 energy rating, see 7-day trends, and have the entry contribute +10 pts to the Momentum Score â€“ all within < 2 s perceived latency.

## âœ… Success Criteria

- PES check-in UI available from Today Feed and Settings (prompt) â€“ passes WCAG AA.
- Upsert to `pes_entries` completes < 300 ms p95 (Flutter âžœ Supabase REST).
- `update-momentum-score` Edge Function invoked; engagement event logged.
- Momentum gauge reflects new score < 5 s (realtime channel push).
- Local notification prompt fires daily at user-selected time; opt-out supported.
- Unit + widget tests â‰¥ 90 % coverage; integration test covering full E2E flow.
- Deprecation PR removes `energy_levels` table, legacy repo methods & tests.

## ðŸ“‹ Milestone Breakdown

| Task ID | Description | Est. Hrs | Status |
| ------- | ----------- | -------- | ------ |
| T1 | Delete `energy_levels` code + migrations; write SQL to drop table | 2h | âœ… |
| T2 | Add PES Check-in widget to Today Feed; wire `EnergyInputSlider` â†’ `insertEnergyLevel()` | 4h | âœ… |
| T3 | Embed `PesTrendSparkline` into Quick-Stats card | 3h | âœ… |
| T4 | Initialise `DailyPromptController` in Settings screen | 2h | âœ… |
| T5 | Update Momentum Calculator: weight map for `pes_entry` (+10) | 3h | âœ… |
| T6 | Remove stale `energy_levels` provider/tests; migrate trend provider to `pes_entries` | 3h | â¬œ |
| T7 | Add e2e Playwright test: slider â†’ DB row â†’ momentum update websocket | 4h | â¬œ |
| T8 | Documentation & release notes | 1h | â¬œ |

## ðŸ“¦ Deliverables

- Flutter UI components integrated in production screens.
- Updated `health_data_repository.dart` exclusively using `pes_entries`.
- Migration script to drop `energy_levels`.
- Edge Function PR: add `pes_entry` weight in `momentum-score-calculator`.
- Playwright e2e spec `pes_checkin_e2e.spec.ts`.
- Updated OpenAPI docs if any admin endpoints adjusted.

## ðŸ”§ Implementation Details

1. **Data**  
   â€¢ Table `pes_entries` already exists with RLS.  
   â€¢ Add DB trigger to reject duplicate same-day inserts after second upsert.

2. **Repository**  
   â€¢ Keep `insertEnergyLevel()`; migrate `fetchEnergyLevels()` â†’ `fetchPesEntries()` for naming consistency.  
   â€¢ Delete `createEnergyLevel()` & caches tied to `energy_levels`.

3. **UI Integration**  
   â€¢ **Today Feed Tile**  
     â€“ Shows `EnergyInputSlider` when no entry for today.  
     â€“ After save, tile collapses to `PesTrendSparkline` + â€œThanks!â€ toast.  
   â€¢ **Settings â†’ Reminders** â€“ expose prompt time picker via `dailyPromptControllerProvider`.

4. **Momentum Wiring**  
   â€¢ `update-momentum-score` Edge Function already logs `pes_entry`.  
   â€¢ **Calculator update:** in `supabase/functions/momentum-score-calculator/index.ts` extend `EVENT_WEIGHTS` map with `'pes_entry': 10`.

5. **Notifications**  
   â€¢ `NotificationSchedulerService` schedules daily prompt; call in Settings save handler.

6. **Deprecation**  
   â€¢ SQL migration: `DROP TABLE IF EXISTS energy_levels CASCADE;`.  
   â€¢ Delete related repository methods, providers, and tests.

7. **Testing**  
   â€¢ Widget test: select emoji â†’ provider state updated; DB call mocked.  
   â€¢ Playwright e2e: simulate Today Feed check-in, assert websocket momentum update.

### Rate-Limiting (No change)
PES insert frequency naturally capped at 1 per user/day by UNIQUE(user_id,date).

## ðŸ“œ Acceptance Criteria Checklist

- [ ] Check-in UI visible on cold launch when no PES recorded today.
- [ ] Entry saves and Momentum Score updates in < 5 s real-time.
- [ ] Daily prompt fires at scheduled time; respects DST changes.
- [ ] Tests & lints pass; coverage â‰¥ 90 %.  
- [ ] Legacy tables/code removed; SQL migration applied.

## ðŸ”— Dependencies / Notes

- Supabase secrets from `~/.bee_secrets/supabase.env` (CI, local dev).
- Relies on Momentum Score listener (Epic 1.8) for realtime channel push.
- Requires Today Feed refactor PR (#T2.2) to allow inserting new card. 