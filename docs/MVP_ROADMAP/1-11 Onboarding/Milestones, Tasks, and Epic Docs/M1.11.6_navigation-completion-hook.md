### M1.11.6 Â· Navigation & Completion Hook

**Epic:** 1.11 Onboarding Intake Surveys\
**Status:** ðŸŸ¡ Planned

---

## ðŸŽ¯ Goal

Finalize onboarding flow by submitting data to Supabase, toggling completion
flag, and routing users to the Home screen on subsequent app launches.

## âœ… Success Criteria

- Transactional submission succeeds or entire op rolls back.
- `profiles.onboarding_complete` set to `true` for current user.
- Home screen loads within 100 ms after splash on next launch.
- Full registrationâ†’onboardingâ†’home E2E test passes on Android & iOS.

## ðŸ“‹ Milestone Breakdown

| Task ID | Description                                                                                                | Est. Hrs | Status     |
| ------- | ---------------------------------------------------------------------------------------------------------- | -------- | ---------- |
| T1      | Submit all collected data via Supabase multi-insert RPC                                                    | 2h       | ðŸŸ¡ Planned |
| T2      | Update `profiles` completion flag                                                                          | 1h       | ðŸŸ¡ Planned |
| T3      | Implement `OnboardingGuard` in `supabase_provider.dart`                                                    | 2h       | ðŸŸ¡ Planned |
| T4      | E2E test covering full happy path                                                                          | 3h       | ðŸŸ¡ Planned |
| T5      | Replace legacy `OnboardingScreen` flow â€“ route RegistrationSuccess & login redirect to `/onboarding/step1` | 2h       | ðŸŸ¡ Planned |
| T6      | Wire navigation between onboarding pages & remove TODO placeholders                                        | 1h       | ðŸŸ¡ Planned |
| T7      | Create `onboarding_serializer.dart` + unit tests for JSON payload                                          | 2h       | ðŸŸ¡ Planned |
| T8      | Write Supabase SQL & migration for `submit_onboarding` RPC (incl. rollback test)                           | 3h       | ðŸŸ¡ Planned |

## ðŸ“¦ Deliverables

- `onboarding_repository.dart` committing draft data.
- Updated `supabase_provider.dart` with guard.
- `integration/launch_controller_flow_test.dart`.
- Docs update in `docs/architecture/flow_diagrams.md`.
- `onboarding_serializer.dart` with 100 % unit test coverage.
- Updated `RegistrationSuccessPage.dart` and `onboarding_redirect.dart` for new
  route.
- SQL migration file + test for `submit_onboarding` RPC.
- UX supports tests ability to evaluate all Epic features on device

## ðŸ”§ Implementation Details

- Use Supabase `rpc('submit_onboarding')` wrapping inserts in SQL
  `BEGIN; COMMIT;`.
- Guard: if user != null & !onboarding_complete â†’ push `/onboarding`.
- Splash delay logic already exists (integration tests referencing).
- Show `CircularProgressIndicator` while submitting; handle offline retry via
  queue.

## ðŸ§ª Testing Approach

- Integration test using real emulator (Android) & simulator (iOS).
- Mock offline scenario then retry once connection restored.
- Use `patrol` package for deep-link tests.

## ðŸ“œ Acceptance Criteria Checklist

- [ ] Data persisted; verified via Supabase query.
- [ ] `onboarding_complete` flag true.
- [ ] Subsequent login skips onboarding.
- [ ] All E2E tests green on CI.
- [ ] Testers able to test features live on device

## ðŸ”— Dependencies / Notes

- Depends on milestones 1â€“5.
- Requires Supabase secrets.
- Ensure `flutter build` passes with `--fatal-warnings`.
