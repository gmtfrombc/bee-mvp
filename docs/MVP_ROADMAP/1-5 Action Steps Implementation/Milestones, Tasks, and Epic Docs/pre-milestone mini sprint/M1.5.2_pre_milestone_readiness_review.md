# üö¶ M1.5.2 ¬∑ Pre-Milestone Readiness Review

## Summary Judgment

‚úÖ Proceed ‚Äì scope and specs are largely complete. Minor clarifications required
before coding starts.

## Missing / Ambiguous Items

1. **Category enumeration** ‚Äì Spec references "enum from design system" but the
   actual list and i18n keys are not provided.
2. **RPC vs direct insert** ‚Äì Decide whether to add `insert_action_step` RPC or
   use `.insert` directly; impacts backend timeline.
3. **Error-handling UX** ‚Äì Snackbar only is mentioned; clarify behavior for
   offline/timeout scenarios.
4. **Onboarding integration** ‚Äì Location of `kHasSetActionStep` flag and
   dependency on Epic 1.11 timing need confirmation.
5. **Accessibility copy** ‚Äì Semantic labels for chips and validation error
   messages require wording guidance.
6. **Analytics schema** ‚Äì Define event parameters for `action_step_set` and
   `action_step_completed`.

## Non-Obvious Edge Cases

- Duplicate goal in the same week ‚Äì update vs insert?
- User edits frequency after days already logged ‚Äì how to reconcile existing
  logs?
- Network loss on submit ‚Äì retry or offline queue?
- Long (multi-line) descriptions within 5-80 chars ‚Äì does the field grow
  gracefully?
- Screen reader focus order when navigating between category dropdown,
  description, and frequency chips.

## Mini QA Plan

‚Ä¢ **Unit / Widget Tests**

- Validation helpers (`isPositivePhrase`, `isFrequencyInRange`).
- `ActionStepController.submit` success & failure paths with mocked Supabase
  client.
- Form enabled/disabled states & button throttling.
- Frequency selector semantics and chip accessibility.

‚Ä¢ **Golden Tests**

- Light & dark themes.
- Mobile (360√ó690) & tablet (768√ó1024) breakpoints.

‚Ä¢ **Integration Tests**

- Supabase emulator: insert and fetch row.
- Error path when Supabase returns 4xx/5xx.

‚Ä¢ **Accessibility Checks**

- Semantics for chips, error text annunciation, focus traversal.
- Verification that confetti respects reduced-motion setting (from later
  milestone).

‚Ä¢ **Performance**

- Measure end-to-end insert latency; fail if > 2 s p95 in CI.

## Action Items

| # | Item                                                 | Owner         | Status      |
| - | ---------------------------------------------------- | ------------- | ----------- |
| 1 | Finalize category enum list & localization keys      | Design        | ‚úÖ Complete |
| 2 | Decide on RPC vs direct insert; create stub if RPC   | Backend       | ‚úÖ Complete |
| 3 | Define offline/timeout UX pattern                    | UX            | ‚úÖ Complete |
| 4 | Document analytics event properties                  | Data          | ‚úÖ Complete |
| 5 | Provide wording for semantic labels & error messages | Accessibility | ‚úÖ Complete |

## Sign-Off

Pending completion of Action Items 1-3 (estimated 0.5-day mini-sprint). Once
addressed, milestone is cleared to begin implementation.

### Decision Log

- **2025-07-15**: Chose _direct insert_ from Flutter
  (`.from('action_steps').insert`) instead of creating an `insert_action_step`
  RPC. Rationale: validation handled client-side; RLS already protects table;
  reduces backend surface area.
- **2025-07-15**: Offline/timeout UX defined ‚Äì on submit, show a _‚ÄúSaving‚Ä¶‚Äù_
  progress indicator. If network request fails within 10 s or device is offline:
  1. Persist draft locally via `SharedPreferences`.
  2. Show banner: ‚ÄúGoal will sync when you‚Äôre back online.‚Äù with _Retry_ button.
  3. A background connectivity listener retries automatically every 30 s until
     success, then shows success snackbar and clears draft. This follows
     existing offline pattern used in Today Feed.

### Analytics Event Properties

| Event Name              | When Fired                                          | Required Params                                                 | Optional Params                                          |
| ----------------------- | --------------------------------------------------- | --------------------------------------------------------------- | -------------------------------------------------------- |
| `action_step_set`       | User successfully saves a new or edited Action Step | `category` (string), `frequency` (int), `description_len` (int) | `source` ("AI-Coach" \| "User"), `week_start` (ISO date) |
| `action_step_completed` | User marks daily completion of an Action Step       | `action_step_id` (uuid), `date` (ISO date)                      | `completed` (bool, defaults `true`)                      |

Implementation note: events are recorded via
`AnalyticsService.logEvent(name, params: {...})`, writing to
`public.analytics_events` table. Params keys must be lower_snake_case and
JSON-serializable.

### Accessibility Wording Guidelines

**Semantic Labels**

‚Ä¢ Category dropdown: `"Action step category"`

‚Ä¢ Description text field: `"Action step description"` (helper: ‚ÄúDescribe what
you‚Äôll DO, 5-80 characters.‚Äù)

‚Ä¢ Frequency chips (3-7): each chip label = `"{n} days per week"`; group
semantics role = "radiogroup" with aria-label "Frequency per week".

**Error Messages**

| Field       | Condition         | Message                                     |
| ----------- | ----------------- | ------------------------------------------- |
| Description | empty             | ‚ÄúDescription can‚Äôt be empty.‚Äù               |
| Description | negative phrasing | ‚ÄúUse positive words (e.g., ‚ÄòWalk 10 min‚Äô).‚Äù |
| Description | too short/long    | ‚ÄúKeep it between 5 and 80 characters.‚Äù      |
| Frequency   | <3 or >7          | ‚ÄúChoose 3‚Äì7 days per week.‚Äù                 |

All error strings added to `intl_en.arb` with keys `action_step_error_empty`,
`action_step_error_positive`, `action_step_error_length`,
`action_step_error_frequency`. Screen readers announce on field blur.
