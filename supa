#!/bin/bash

# ğŸ BEE-MVP Supabase Startup Script
# Starts Docker (if needed) and Supabase functions server

set -e  # Exit on any error

echo "ğŸ Starting BEE-MVP Supabase Environment..."

# Function to check if Docker is running
check_docker() {
    docker info >/dev/null 2>&1
}

# Function to start Docker Desktop
start_docker() {
    echo "ğŸ³ Starting Docker Desktop..."
    
    # Try to start Docker Desktop (macOS)
    if [[ "$OSTYPE" == "darwin"* ]]; then
        open -a Docker
    else
        # For Linux, try systemctl
        sudo systemctl start docker 2>/dev/null || echo "âš ï¸  Please start Docker manually"
    fi
    
    echo "â³ Waiting for Docker to be ready..."
    
    # Wait up to 60 seconds for Docker to start
    local timeout=60
    local elapsed=0
    
    while ! check_docker && [ $elapsed -lt $timeout ]; do
        sleep 2
        elapsed=$((elapsed + 2))
        printf "."
    done
    
    echo ""
    
    if ! check_docker; then
        echo "âŒ Docker failed to start within $timeout seconds"
        echo "Please start Docker manually and try again"
        exit 1
    fi
    
    echo "âœ… Docker is ready!"
}

# Check if Docker is running
if ! check_docker; then
    echo "ğŸ” Docker not running, starting it..."
    start_docker
else
    echo "âœ… Docker is already running"
fi

# Kill any existing Supabase functions server
echo "ğŸ§¹ Cleaning up any existing Supabase processes..."
pkill -f "supabase functions serve" 2>/dev/null || true

echo "ğŸš€ Preparing dev environment variables..."

# Create temp env file overriding ENVIRONMENT for local functions serve
TEMP_ENV_FILE="./app/.env.dev.local"
cp ./app/.env "$TEMP_ENV_FILE"
# Remove existing ENVIRONMENT line if present and append development value
sed -i '' '/^ENVIRONMENT=/d' "$TEMP_ENV_FILE"
echo "ENVIRONMENT=development" >> "$TEMP_ENV_FILE"

# Start Supabase functions server
echo "ğŸš€ Starting Supabase functions server..."
echo "ğŸ“ Using environment file: $TEMP_ENV_FILE"
echo "ğŸŒ Server will be available at: http://127.0.0.1:54321"
echo ""
echo "ğŸ’¡ Press Ctrl+C to stop the server"
echo "ğŸ“‹ Logs will appear below:"
echo "----------------------------------------"

# Start the server
supabase functions serve --env-file "$TEMP_ENV_FILE"

echo ""
echo "ğŸ›‘ Supabase server stopped" 